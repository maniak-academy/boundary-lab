slug: boundary-quick-local-demo
id: o5law9hvqypq
version: 0.0.5
title: Demo Boundary
teaser: Boundary Demo env (SSH, PSQL, Exec, RDP)
description: Test Boundary PKI Workers and various Target types - based upon Andrew
  Klass
icon: https://registry.terraform.io/images/providers/boundary.svg
tags:
- Vault
- Boundary
owner: hashicorp
developers:
- aklaas@hashicorp.com
- sebastian.maniak@hashicorp.com
challenges:
- slug: 01-boundary-worker-setup
  id: sgmnv1azxblx
  type: challenge
  title: Boundary Demo
  teaser: Boundary Demo
  notes:
  - type: text
    contents: Boundary Lab Environment.
  assignment: |-
    NOTE: (username: vault, password: vault) for the Vault UI tab (userpass auth method)
    1. Setup an HCP Cluster https://portal.cloud.hashicorp.com/sign-in
    2. Find the boundary URL and create the following env variables.

    ```
    export BOUNDARY_ADDR=
    ```
    Set the TF var as well (used later).
    ```
    export TF_VAR_boundary_addr=${BOUNDARY_ADDR}
    ```
    Set the admin user you created in the HCP portal.
    ```
    export ADMIN_USER=
    ```

    3. You need to log into HCP Boundary cluster find the iniiate auth method ID.
    note: v 0.12 auth method id will be set to the default so we wont need to do this.

    Set the id.
    ```
    export TF_VAR_auth_method_id=
    ```
    4. Login to the cluster. Once logged in, a Boundary token will be returned.
    ```
    boundary authenticate password -auth-method-id=${TF_VAR_auth_method_id} -login-name=$ADMIN_USER
    ```
    5. Set the Boundary token.
    ```
    export BOUNDARY_TOKEN=
    ```
    6. Create a boundary vault policy and build out the environment
    ```
    cd terraform-boundary/
    vault login -method=userpass username=vault password=vault
    export BOUNDARY_VAULT_TOKEN=$(vault token create \
      -no-default-policy=true \
      -policy="vault_admin" \
      -orphan=true \
      -period=20m \
      -renewable=true \
      -format=json | jq -r .auth.client_token)
    export TF_VAR_vault_token=${BOUNDARY_VAULT_TOKEN}
    terraform init -upgrade
    terraform init
    terraform apply --auto-approve;
    ```

    7. Set env variables for our project and targets
    ```
    export PROJECT_ID=$(terraform output -raw PROJECT_ID)
    export POSTGRES_TARGET_ID=$(terraform output -raw POSTGRES_TARGET_ID)
    export SSH_BROKERED_TARGET_ID=$(terraform output -raw SSH_BROKERED_TARGET_ID)
    export SSH_INJECTED_TARGET_ID=$(terraform output -raw SSH_INJECTED_TARGET_ID)
    export VAULT_TARGET_ID=$(terraform output -raw VAULT_TARGET_ID)
    export WORKER_TOKEN=$(terraform output -raw WORKER_TOKEN)
    echo $PROJECT_ID
    echo $POSTGRES_TARGET_ID
    echo $SSH_BROKERED_TARGET_ID
    echo $SSH_INJECTED_TARGET_ID
    echo $VAULT_TARGET_ID
    ```
    8. The below command will output the worker_token from the Terraform output as well as the UUID of the cluster.
    ```
    echo $BOUNDARY_ADDR | awk -F/ '{print $3}' |  awk -F'.' '{print $1}'
    echo $WORKER_TOKEN
    ```
    9. Switch to the "Boundary Worker Editor" tab and add them in the code editor in place of the REPLACEME variables.
    Save the file and switch back to the "Boundary Worker" tab.
    10. Now, start the boundary-worker.

    ```
    systemctl restart boundary-worker
    ```

    11. HCP boundary you should see the worker being registerd
    ```
    boundary workers list -token env://BOUNDARY_TOKEN
    ```

    12. You can also use the following to troubleshoot systemd
    ```
    journalctl -u boundary-worker
    ```

    13. Now let's setup the Vault integration. This has to be done manually for now until the terraform provider is updated.
    https://github.com/hashicorp/terraform-provider-boundary/issues/294


    ```
    export CRED_STORE_ID=$(boundary credential-stores create vault \
      -scope-id $PROJECT_ID \
      -vault-address "http://vault-sql-server:8200" \
      -vault-token $BOUNDARY_VAULT_TOKEN \
      -worker-filter='"vault" in "/tags/type"' \
      -format json \
      -token env://BOUNDARY_TOKEN | jq -r '.item.id')
    ```

    **POSTGRES DEMO**

    First, create the credential-library. This tells Boundary where to grab a cred from Vault.

    ```
    export CRED_LIB_ID=$(boundary credential-libraries create vault \
      -credential-store-id $CRED_STORE_ID \
      -vault-path "database/creds/vault_go_demo" \
      -name "vault-cred-library-postgres" \
      -format json \
      -token env://BOUNDARY_TOKEN | jq -r '.item.id')

    boundary targets add-credential-sources \
      -id $POSTGRES_TARGET_ID \
      -brokered-credential-source $CRED_LIB_ID \
      -token env://BOUNDARY_TOKEN
    ```
    Authorize a session (optional). This returns a brokered credential and connect to the target.
    ```
    boundary targets authorize-session -id  $POSTGRES_TARGET_ID -token env://BOUNDARY_TOKEN
    boundary connect postgres -target-id $POSTGRES_TARGET_ID --dbname vault_go_demo -token env://BOUNDARY_TOKEN
    ```

    **SSH INJECTED CREDS DEMO**

    Injected: No credential is returned to user. (i.e. Passwordless)

    ```
    export CRED_LIB_ID_SSH=$(boundary credential-libraries create vault \
      -credential-store-id $CRED_STORE_ID \
      -vault-path "secret/data/my-secret" \
      -name "vault-cred-library-ssh" \
      -credential-type ssh_private_key \
      -format json \
      -token env://BOUNDARY_TOKEN | jq -r '.item.id')

    boundary targets add-credential-sources \
      -id $SSH_INJECTED_TARGET_ID \
      -injected-application-credential-source $CRED_LIB_ID_SSH \
      -token env://BOUNDARY_TOKEN
    ```
    Connect to the target via the injected credential (The private key is not returned). You can use the Vault admin UI if you need to see the key.
    ```
    boundary targets authorize-session -id  $SSH_INJECTED_TARGET_ID -token env://BOUNDARY_TOKEN
    boundary connect ssh -target-id $SSH_INJECTED_TARGET_ID -token env://BOUNDARY_TOKEN
    ```

    **SSH STATIC CREDS (INTERNAL BOUNDARY CREDENTIAL STORE)**

    This will leverage Boundary's built-in credential store (configured via Terraform above).
    ```
    boundary targets authorize-session -id $SSH_BROKERED_TARGET_ID
    ```
    ```
    boundary connect ssh -target-id $SSH_BROKERED_TARGET_ID
    ```

    **VAULT ACCESS DEMO**

    Using Boundary exec to create a secure TCP connection to wrap the Vault binary.
    ```
    boundary connect -exec vault -target-id $VAULT_TARGET_ID -- secrets list
    ```

    Let's move on to the RDP/Windows demo.

    # windows Demo
      Switch to the "remote Desktop tab". This is connected to a front end windows servers and will simulate the client in our demo.

    Open a powershell. (click windows button bottom left, then search for powershell).

    Remember: Windows uses Ctrl-C not Cmd-C for copy.

    Install Boundary Cli and Boundary Desktop

    ```
    cd C:\Users\instruqt\Downloads\
    curl.exe --output boundary.zip --url https://releases.hashicorp.com/boundary-desktop/1.5.1/boundary-desktop_1.5.1_windows_amd64.zip


    cd C:\Users\instruqt\Downloads\
    curl.exe --output boundary_cli.zip --url https://releases.hashicorp.com/boundary/0.12.0/boundary_0.12.0_windows_amd64.zip

    Expand-Archive -PATH boundary.zip -DestinationPath boundary-desktop
    Expand-Archive -PATH boundary_cli.zip -DestinationPath boundary-cli

    cd C:\Users\instruqt\Downloads\
    curl.exe --output boundary.zip --url https://releases.hashicorp.com/boundary-desktop/1.5.0/boundary-desktop_1.5.0_windows_amd64.zip


    ```
    C:\Users\instruqt\Downloads\boundary-desktop\Boundary\boundary-desktop_1.5.1_.exe
    ```
    If you use the boundary-desktop, login and create a connection to the target.

    You will need to input the boundary cluster URL. Login with your credentials and click the "connect" button for the windows_server target .

    Open a new powershell and connect. (replace the port with the output from the Boundary desktop above).

    ```
    mstsc /v:127.0.0.1:49814
    ```
    Login with the following credentials
    ```
    u: instruqt
    p: Passw0rd!
    ```

    **BOUNDARY CLI**

    If you want to use powershell and the Boundary CLI directly, set the following environment variables
    ```
    $Env:BOUNDARY_ADDR = ""
    ```
    ```
    $Env:ADMIN_USER = ""
    ```
    ```
    $Env:AUTH_METHOD = ""
    ```
    Next Login to boundary from powershell.
    ```
    C:\Users\instruqt\Downloads\boundary-cli\boundary.exe authenticate password -auth-method-id $Env:AUTH_METHOD -login-name $Env:ADMIN_USER
    ```
    Grab the ID of the target from the console (You could do this via command line as well).
    Grab this information from the corp_one scope in your Boundary Cluster admin UI. (accessible from HCP portal)
    The target is the "windows_server" target id under your corp_one scope -> targets section.
    ```
    $env:TARGET_ID = ""
    ```
    ```
    C:\Users\instruqt\Downloads\boundary-cli\boundary.exe connect rdp -target-id $Env:TARGET_ID
    ```
    Login with the following credentials
    ```
    u: instruqt
    p: Passw0rd!
    ```
    We could if optionally used Vault's LDAP/AD secret engine or K/V secret engine for brokering these credentials.

    Azure AD: Setup azure AAD
  tabs:
  - title: Boundary Worker
    type: terminal
    hostname: boundary-worker
  - title: Boundary Worker Editor
    type: code
    hostname: boundary-worker
    path: /etc/boundary.d/pki-worker.hcl
  - title: Terraform Editor
    type: code
    hostname: boundary-worker
    path: /root/terraform-boundary/main.tf
  - title: Vault UI
    type: service
    hostname: vault-sql-server
    port: 8200
  - title: Vault & SQL Server
    type: terminal
    hostname: vault-sql-server
  - title: Remote Desktop
    type: service
    hostname: guac
    path: /#/client/c/srv01?username=guac_user&password=guac_password
    port: 8080
  - title: Windows Server PS
    type: terminal
    hostname: windows-server
  - title: Windows Destination
    type: terminal
    hostname: windows-destination
  difficulty: basic
  timelimit: 172800
checksum: "12648300828198685717"
